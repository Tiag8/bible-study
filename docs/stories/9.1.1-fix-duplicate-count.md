# Story 9.1.1: Fix Bug de Contagem Duplicada

**Epic**: [EPIC-9.1-chapter-count-fix.md](./EPIC-9.1-chapter-count-fix.md)
**Status**: âœ… Done
**Priority**: ğŸ”´ CRÃTICO
**Assignee**: @dev
**Estimativa**: 5 min

---

## User Story

**Como** um usuÃ¡rio do Bible Study,
**Quero** ver a contagem correta de capÃ­tulos estudados,
**Para** ter uma visÃ£o precisa do meu progresso bÃ­blico.

---

## Contexto do Bug

### Sintoma
- GÃªnesis mostra "2 de 50 estudados"
- Realidade: apenas 1 capÃ­tulo (cap 2) com 2 estudos dentro

### Root Cause
```typescript
// DashboardClient.tsx:49 - BUGADO
const studiedChapters = bookStudies.map((s) => s.chapter_number);
// Resultado: [2, 2] (conta duplicatas)

// ChapterView.tsx:69 - MESMO BUG
const studiedChapters = bookStudies.map(s => s.chapter_number);
```

### Impacto
- 100% dos usuÃ¡rios veem informaÃ§Ã£o incorreta
- Afeta BookCard (por livro) e BookGrid (total)

---

## Acceptance Criteria

### Funcional
- [ ] `DashboardClient.tsx:49` usa `[...new Set(bookStudies.map(s => s.chapter_number))]`
- [ ] `ChapterView.tsx:69` usa mesma lÃ³gica
- [ ] GÃªnesis com 2 estudos no cap 2 mostra "1 de 50 estudados"
- [ ] Total no topo reflete capÃ­tulos Ãºnicos (nÃ£o estudos)

### TÃ©cnico
- [ ] Build passa sem erros (`npm run build`)
- [ ] Lint passa (`npm run lint`)
- [ ] Nenhuma regressÃ£o em funcionalidades existentes

### ValidaÃ§Ã£o Manual
- [ ] Dashboard carrega normalmente
- [ ] BookCard mostra contagem correta
- [ ] ChapterView mostra tiles corretos
- [ ] Progress bar reflete % correta

---

## EspecificaÃ§Ã£o TÃ©cnica

### Arquivo 1: `src/app/DashboardClient.tsx`

**LocalizaÃ§Ã£o**: Linha 49

```typescript
// ANTES (linha 49)
const studiedChapters = bookStudies.map((s) => s.chapter_number);

// DEPOIS
const studiedChapters = [...new Set(bookStudies.map((s) => s.chapter_number))];
```

### Arquivo 2: `src/components/dashboard/ChapterView.tsx`

**LocalizaÃ§Ã£o**: Linha 69

```typescript
// ANTES (linha 69)
const studiedChapters = bookStudies.map(s => s.chapter_number);

// DEPOIS
const studiedChapters = [...new Set(bookStudies.map(s => s.chapter_number))];
```

---

## Definition of Done

- [ ] CÃ³digo alterado em ambos os arquivos
- [ ] Build passa
- [ ] ValidaÃ§Ã£o manual: GÃªnesis mostra contagem correta
- [ ] Commit criado com mensagem apropriada

---

## Notas de ImplementaÃ§Ã£o

### Por que `Set`?
- `Set` automaticamente remove duplicatas
- `[...new Set(array)]` converte de volta para array
- Performance O(n) - negligÃ­vel para 66 livros

### NÃ£o precisa de:
- MudanÃ§as no banco de dados
- Novas funÃ§Ãµes/hooks
- Testes (story separada 9.1.2)

---

## Commit Message Sugerida

```
fix(dashboard): contar capÃ­tulos Ãºnicos ao invÃ©s de estudos

- Usar Set para deduplicar chapter_number em DashboardClient
- Aplicar mesmo fix em ChapterView
- Resolve bug onde 2 estudos no cap 2 mostrava "2 de 50"

Fixes: bug de contagem duplicada reportado em anÃ¡lise 360Â°
```

---

**Criado por**: Morgan (PM) ğŸ“‹
**Data**: 2026-02-05
