# Story 5.1.2: Tooltip de Visualizacao + Editar + Excluir

**Epic**: 5.1 - Comentarios Inline no Editor (estilo Notion)
**Status**: Done ✅
**Priority**: Alta
**Story Points**: 5
**Assignee**: @dev
**Depends On**: Story 5.1.1 (Comment Mark + BubbleMenu)

---

## USER STORY

**Como** um estudioso biblico
**Quero** visualizar, editar e excluir comentarios existentes ao interagir com o texto destacado
**Para** revisar minhas anotacoes e mante-las atualizadas conforme meu entendimento evolui

### Why This Matters
- Revisao de anotacoes e essencial para estudo progressivo
- Edicao permite refinar insights ao longo do tempo
- Exclusao permite limpar anotacoes que nao sao mais relevantes

---

## CRITERIOS DE ACEITACAO

### A. Tooltip de Visualizacao (Desktop)

```gherkin
Scenario: Hover exibe tooltip com comentario
  Given o trecho "o amor de Deus" tem um comentario salvo
  When passo o mouse sobre o highlight amarelo/laranja
  Then tooltip aparece proximo ao texto com:
    | Campo | Valor |
    | Texto | "Reflexao sobre agape vs phileo" |
    | Botao Editar | Icone Pencil |
    | Botao Excluir | Icone Trash2 |
  And tooltip desaparece quando movo o mouse para fora

Scenario: Tooltip nao aparece durante selecao de texto
  Given o trecho "o amor de Deus" tem um comentario
  When estou selecionando texto (BubbleMenu ativo)
  Then tooltip NAO aparece (BubbleMenu tem prioridade)
```

**Tarefas Tecnicas**:
- [x] Criar `src/components/Editor/CommentTooltip.tsx`
- [x] Detectar hover sobre elemento com class `comment-highlight`
- [x] Posicionar tooltip acima ou abaixo do texto (calcular posicao)
- [x] Exibir `commentText` do mark attrs
- [x] Botoes: icone `Pencil` (editar) e `Trash2` (excluir) do Lucide
- [x] Delay no hover (ex: 200ms) para evitar flickering
- [x] Nao exibir quando ha selecao ativa (verificar `editor.state.selection.empty`)

---

### B. Tooltip de Visualizacao (Mobile)

```gherkin
Scenario: Tap exibe tooltip em mobile
  Given estou em dispositivo mobile/tablet
  And o trecho "o amor de Deus" tem um comentario
  When toco no highlight amarelo/laranja
  Then tooltip aparece com texto e botoes (editar, excluir)
  And tooltip fecha ao tocar fora dele
```

**Tarefas Tecnicas**:
- [x] Evento `click`/`touchend` em mobile (detectar via media query ou pointer type)
- [x] Fechar tooltip ao clicar fora (click outside handler)
- [x] Tamanho touch-friendly para botoes (min 44x44px)

---

### C. Editar Comentario

```gherkin
Scenario: Editar texto do comentario
  Given tooltip esta visivel com comentario "Reflexao sobre agape vs phileo"
  When clico no botao editar (Pencil)
  Then popover aparece com textarea pre-preenchida com o texto atual
  And botoes "Salvar" e "Cancelar"

Scenario: Salvar edicao
  Given popover de edicao esta aberto
  And alterei texto para "Agape = amor incondicional de Deus"
  When clico "Salvar"
  Then mark comment atualiza commentText
  And tooltip mostra texto atualizado no proximo hover
  And auto-save persiste a mudanca
```

**Tarefas Tecnicas**:
- [x] Reutilizar `BubbleMenuComment.tsx` em modo edicao (prop `initialText`)
- [x] Ou criar popover inline no proprio tooltip
- [x] Handler `updateComment(commentId, newText)` em `useBubbleMenuHandlers.ts`
- [x] Localizar mark por `commentId` no documento
- [x] Atualizar attrs do mark mantendo `commentId` e `createdAt` originais
- [x] Fechar tooltip e popover apos salvar

---

### D. Excluir Comentario

```gherkin
Scenario: Excluir comentario com confirmacao
  Given tooltip esta visivel com comentario
  When clico no botao excluir (Trash2)
  Then modal de confirmacao aparece: "Excluir este comentario?"
  And botoes "Cancelar" e "Excluir"

Scenario: Confirmar exclusao
  Given modal de confirmacao esta aberto
  When clico "Excluir"
  Then mark comment e removido do trecho
  And highlight amarelo/laranja desaparece
  And texto original permanece intacto
  And auto-save persiste a remocao

Scenario: Cancelar exclusao
  Given modal de confirmacao esta aberto
  When clico "Cancelar"
  Then modal fecha
  And comentario permanece inalterado
```

**Tarefas Tecnicas**:
- [x] Reutilizar modal de confirmacao existente (ConfirmDialog/AlertDialog do projeto)
- [x] Handler `removeComment(commentId)` em `useBubbleMenuHandlers.ts`
- [x] Localizar mark por `commentId` e remover com `editor.chain().unsetMark('comment')`
- [x] Garantir que apenas o mark e removido, texto permanece
- [x] Fechar tooltip antes de abrir modal

---

## ARQUIVOS MODIFICADOS (Previsao)

| Arquivo | Acao | Descricao |
|---------|------|-----------|
| `src/components/Editor/CommentTooltip.tsx` | NOVO | Tooltip com texto + acoes |
| `src/components/Editor/BubbleMenu/useBubbleMenuHandlers.ts` | EDITAR | Handlers updateComment, removeComment |
| `src/components/Editor/BubbleMenu/BubbleMenuComment.tsx` | EDITAR | Suportar modo edicao (prop initialText) |
| `src/components/Editor/index.tsx` | EDITAR | Integrar CommentTooltip |
| `src/app/globals.css` | EDITAR | Estilos do tooltip |

---

## QUALITY GATES

**Pre-Commit**:
- [x] `npm run build` passa sem erros
- [x] `npm run lint` passa sem warnings
- [x] Tooltip aparece no hover (desktop)
- [x] Tooltip aparece no tap (mobile)
- [x] Edicao de comentario funciona
- [x] Exclusao com confirmacao funciona

**Pre-PR**:
- [x] CRUD completo testado: criar (5.1.1) → ver → editar → excluir
- [x] Persistencia apos cada operacao (recarregar pagina)
- [x] Nenhuma regressao no BubbleMenu existente
- [x] Testar conflito tooltip vs BubbleMenu (nao devem aparecer juntos)
- [x] Testar em mobile (responsive)

---

## NOTAS PARA @dev

1. **Prioridade de interacao**: BubbleMenu > CommentTooltip. Se ha selecao ativa, tooltip nao aparece
2. **Modal de confirmacao**: Reutilizar componente existente (verificar `src/components/ui/` por AlertDialog)
3. **Localizar mark por ID**: Iterar `editor.state.doc.descendants()` buscando mark com `commentId` correspondente
4. **updateComment**: Pode usar `editor.chain().extendMarkRange('comment').updateAttributes('comment', { commentText }).run()`
5. **removeComment**: Posicionar cursor no range do mark e `unsetMark('comment')`
