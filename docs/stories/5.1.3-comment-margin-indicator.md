# Story 5.1.3: Indicador Visual na Margem

**Epic**: 5.1 - Comentarios Inline no Editor (estilo Notion)
**Status**: Pending
**Priority**: Media
**Story Points**: 3
**Assignee**: @dev
**Depends On**: Story 5.1.1 (Comment Mark)

---

## USER STORY

**Como** um estudioso biblico
**Quero** ver icones na margem do editor indicando onde ha comentarios
**Para** identificar rapidamente quais trechos do estudo possuem anotacoes

### Why This Matters
- Navegacao rapida entre comentarios sem precisar escanear todo o texto
- Indicador visual sutil que nao polui a leitura
- Padrao conhecido de editores (VS Code, Google Docs)

---

## CRITERIOS DE ACEITACAO

### A. Icone na Margem

```gherkin
Scenario: Linhas com comentario exibem icone na margem
  Given o estudo tem 3 comentarios em paragrafos diferentes
  When visualizo o editor
  Then vejo 3 icones MessageSquare na margem esquerda
  And cada icone esta alinhado com a linha do respectivo comentario

Scenario: Linhas sem comentario nao exibem icone
  Given um paragrafo nao tem nenhum comentario
  When visualizo o editor
  Then nao ha icone na margem desse paragrafo
```

**Tarefas Tecnicas**:
- [ ] Criar `src/components/Editor/CommentMarginIcon.tsx`
- [ ] Usar Tiptap `NodeViewDecoration` ou CSS `position: absolute` na margem
- [ ] Icone `MessageSquare` (Lucide) em tamanho pequeno (14-16px)
- [ ] Cor sutil (ex: `text-amber-400/60`) que nao compete com o conteudo
- [ ] Posicionar na margem esquerda do editor (fora do content area)

---

### B. Interacao com Icone

```gherkin
Scenario: Click no icone foca o trecho comentado
  Given vejo icone na margem de um paragrafo
  When clico no icone
  Then editor faz scroll ate o trecho comentado (se nao visivel)
  And o trecho comentado recebe um flash de highlight temporario (feedback visual)
```

**Tarefas Tecnicas**:
- [ ] Click no icone: localizar o mark `comment` naquela linha
- [ ] `editor.commands.scrollIntoView()` se necessario
- [ ] Flash de highlight: adicionar class temporaria (ex: 300ms de brilho)
- [ ] Ou abrir tooltip do comentario diretamente

---

### C. Responsividade

```gherkin
Scenario: Mobile exibe icone menor e touch-friendly
  Given estou em dispositivo mobile (< 768px)
  When visualizo editor com comentarios
  Then icones na margem sao menores mas ainda visiveis (12px)
  And area de toque e adequada (min 32x32px hitbox)

Scenario: Margem nao quebra layout em telas pequenas
  Given editor esta em tela < 640px
  When ha icones na margem
  Then conteudo do editor nao e empurrado ou sobreposto
```

**Tarefas Tecnicas**:
- [ ] Responsive: icone menor em mobile (12-14px)
- [ ] Hitbox adequada para touch (padding invisivel)
- [ ] Testar que margem nao interfere com padding do editor
- [ ] Se margem causar problema de layout em mobile: considerar esconder e usar apenas highlight

---

## ABORDAGEM TECNICA

**Opcao recomendada**: Tiptap Plugin com decorations

O Tiptap/ProseMirror permite criar `Decorations` que renderizam widgets na margem. Essa abordagem:
- Nao modifica o documento (decorations sao visuais)
- Atualiza automaticamente quando marks mudam
- Segue o padrao ProseMirror (performatico)

```typescript
// Pseudocodigo da abordagem
Plugin({
  props: {
    decorations(state) {
      // Percorre doc buscando marks 'comment'
      // Para cada mark encontrado, cria widget decoration na margem
      return DecorationSet.create(state.doc, decorations)
    }
  }
})
```

**Alternativa simples**: CSS `::before` pseudo-element no `.comment-highlight` com `position: absolute` e `left` negativo. Mais simples mas menos flexivel.

---

## ARQUIVOS MODIFICADOS (Previsao)

| Arquivo | Acao | Descricao |
|---------|------|-----------|
| `src/components/Editor/CommentMarginIcon.tsx` | NOVO | Componente do icone ou plugin |
| `src/components/Editor/index.tsx` | EDITAR | Registrar plugin/decoration |
| `src/app/globals.css` | EDITAR | Estilos do icone na margem |

---

## QUALITY GATES

**Pre-Commit**:
- [ ] `npm run build` passa sem erros
- [ ] `npm run lint` passa sem warnings
- [ ] Icones aparecem na margem para comentarios existentes
- [ ] Click no icone foca o trecho

**Pre-PR**:
- [ ] Testar com multiplos comentarios no mesmo estudo
- [ ] Testar em desktop e mobile
- [ ] Layout do editor nao quebra com icones
- [ ] Nenhuma regressao em funcionalidades existentes
- [ ] Performance aceitavel com muitos comentarios (10+)

---

## NOTAS PARA @dev

1. **Comece pela abordagem simples** (CSS `::before`) e so migre para Plugin se necessario
2. **Nao bloquear**: Esta story e independente da 5.1.2, pode ser feita em paralelo
3. **Se margem causar problemas de layout**: e aceitavel esconder em mobile e manter apenas highlight
4. **Performance**: Decorations ProseMirror sao recalculadas a cada transacao, mas sao leves para poucos comentarios
