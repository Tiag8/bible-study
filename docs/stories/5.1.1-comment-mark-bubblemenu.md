# Story 5.1.1: Custom Comment Mark + BubbleMenu Integration

**Epic**: 5.1 - Comentarios Inline no Editor (estilo Notion)
**Status**: Done ✅
**Priority**: Alta
**Story Points**: 5
**Assignee**: @dev
**Depends On**: Nenhuma (primeira story do epic)

---

## USER STORY

**Como** um estudioso biblico
**Quero** selecionar um trecho de texto no editor e adicionar um comentario/reflexao
**Para** registrar insights e anotacoes diretamente no contexto do texto estudado

### Why This Matters
- Anotacoes contextuais aumentam retencao de insights
- Padrao Notion/Obsidian que usuarios ja conhecem
- Base para todo o sistema de comentarios (stories 5.1.2 e 5.1.3 dependem desta)

---

## CRITERIOS DE ACEITACAO

### A. Criar Comment Mark (Extensao Tiptap)

```gherkin
Scenario: Extensao CommentMark registrada no editor
  Given o editor Tiptap carrega
  When verifico as extensoes registradas
  Then CommentMark esta presente com attrs: commentId, commentText, createdAt
  And excludes 'comment' (impede sobreposicao)
```

**Tarefas Tecnicas**:
- [x] Criar `src/components/Editor/CommentMark.ts`
- [x] Definir Mark com `name: 'comment'`
- [x] Attrs: `commentId` (string, UUID), `commentText` (string), `createdAt` (string, ISO date)
- [x] `excludes: 'comment'` para impedir sobreposicao de comentarios
- [x] `parseHTML`: parse `<span>` com `data-comment-id`
- [x] `renderHTML`: renderiza como `<span class="comment-highlight" data-comment-id="...">`
- [x] Registrar no array de extensions em `src/components/Editor/index.tsx`

**Referencia de padrao**: `src/components/Editor/ColoredBlockquote.ts` (custom extension existente)

---

### B. Botao no BubbleMenu

```gherkin
Scenario: Icone de comentario aparece no BubbleMenu
  Given seleciono um trecho de texto no editor
  When o BubbleMenu aparece
  Then vejo icone MessageSquare junto aos botoes existentes (bold, italic, etc)
  And o icone esta desabilitado se o texto selecionado ja tem comentario
```

**Tarefas Tecnicas**:
- [x] Adicionar botao `MessageSquare` (Lucide) em `src/components/Editor/BubbleMenu/BubbleMenuToolbar.tsx`
- [x] Posicionar apos os botoes de formatacao existentes (separador visual opcional)
- [x] Estado disabled quando selecao ja contem mark `comment`
- [x] Click abre modo `comment` no BubbleMenu (similar ao modo `link` existente)

**Referencia de padrao**: `BubbleMenuLink.tsx`, `BubbleMenuHighlight.tsx`

---

### C. Popover de Criacao

```gherkin
Scenario: Criar comentario via popover
  Given seleciono texto "o amor de Deus" no editor
  And clico no icone MessageSquare no BubbleMenu
  When o popover aparece proximo ao texto selecionado
  Then vejo textarea vazia com placeholder "Adicionar comentario..."
  And vejo botao "Salvar" e botao "Cancelar"

Scenario: Salvar comentario
  Given popover de comentario esta aberto
  And digitei "Reflexao sobre agape vs phileo"
  When clico "Salvar"
  Then texto "o amor de Deus" recebe highlight amarelo/laranja
  And popover fecha
  And BubbleMenu fecha
  And mark comment contem commentId, commentText e createdAt
```

**Tarefas Tecnicas**:
- [x] Criar `src/components/Editor/BubbleMenu/BubbleMenuComment.tsx`
- [x] Textarea com placeholder "Adicionar comentario..."
- [x] Botao "Salvar" (primary) e "Cancelar" (ghost)
- [x] Gerar `commentId` com `crypto.randomUUID()`
- [x] `createdAt` com `new Date().toISOString()`
- [x] Focus automatico na textarea ao abrir

**Referencia de padrao**: `BubbleMenuLink.tsx` (popover com input)

---

### D. Handler no useBubbleMenuHandlers

```gherkin
Scenario: setComment aplica mark no texto selecionado
  Given texto esta selecionado
  When setComment e chamado com commentText
  Then editor.chain().setMark('comment', { commentId, commentText, createdAt }).run()
  And selecao e removida apos aplicar
```

**Tarefas Tecnicas**:
- [x] Adicionar `setComment(commentText: string)` em `src/components/Editor/BubbleMenu/useBubbleMenuHandlers.ts`
- [x] Gerar UUID e timestamp dentro do handler
- [x] Chamar `editor.chain().focus().setMark('comment', attrs).run()`

---

### E. Estilo Visual (Highlight)

```gherkin
Scenario: Texto comentado tem highlight visual
  Given um comentario foi salvo no trecho "o amor de Deus"
  When visualizo o editor
  Then o trecho tem fundo amarelo/laranja sutil (similar ao Notion)
  And o highlight nao interfere com outros marks (bold, italic, etc)
```

**Tarefas Tecnicas**:
- [x] CSS para `.comment-highlight` com `background-color` amarelo/laranja
- [x] Opacidade sutil para nao poluir leitura (ex: `rgba(255, 183, 77, 0.3)`)
- [x] Cursor `pointer` no hover para indicar interatividade
- [x] Adicionar estilos em `src/app/globals.css`

---

### F. Persistencia via Auto-Save

```gherkin
Scenario: Comentario persiste apos recarregar pagina
  Given criei um comentario no trecho "o amor de Deus"
  When auto-save executa (30s) ou salvo manualmente
  And recarrego a pagina
  Then o trecho "o amor de Deus" continua com highlight amarelo/laranja
  And o mark comment contem commentId, commentText e createdAt corretos
```

**Tarefas Tecnicas**:
- [x] Verificar que `editor.getJSON()` inclui o mark `comment` nos dados
- [x] Nenhuma mudanca necessaria no auto-save (ja persiste content JSONB)
- [x] Testar: criar comentario → salvar → recarregar → mark preservado

---

## ARQUIVOS MODIFICADOS (Previsao)

| Arquivo | Acao | Descricao |
|---------|------|-----------|
| `src/components/Editor/CommentMark.ts` | NOVO | Custom Tiptap Mark |
| `src/components/Editor/index.tsx` | EDITAR | Registrar CommentMark nas extensions |
| `src/components/Editor/BubbleMenu/BubbleMenuToolbar.tsx` | EDITAR | Adicionar botao MessageSquare |
| `src/components/Editor/BubbleMenu/BubbleMenuComment.tsx` | NOVO | Popover de criacao |
| `src/components/Editor/BubbleMenu/useBubbleMenuHandlers.ts` | EDITAR | Handler setComment |
| `src/components/Editor/BubbleMenu/types.ts` | EDITAR | Tipo para modo 'comment' |
| `src/app/globals.css` | EDITAR | Estilo .comment-highlight |

---

## QUALITY GATES

**Pre-Commit**:
- [x] `npm run build` passa sem erros
- [x] `npm run lint` passa sem warnings
- [x] Criar comentario funciona (fluxo completo)
- [x] Highlight visivel no texto
- [x] Persistencia funciona (recarregar pagina)

**Pre-PR**:
- [x] Testar em desktop (Chrome, Firefox)
- [x] Testar em mobile (responsive)
- [x] BubbleMenu existente continua funcionando (bold, italic, link, etc)
- [x] Auto-save funciona normalmente
- [x] Nao ha regressao em funcionalidades existentes

---

## NOTAS PARA @dev

1. **Padrao a seguir**: `ColoredBlockquote.ts` para a extensao, `BubbleMenuLink.tsx` para o popover
2. **Nao criar tabela/migration**: Tudo persiste no JSONB via mark
3. **UUID client-side**: `crypto.randomUUID()` (suporte browser moderno)
4. **Excludes**: `excludes: 'comment'` impede sobreposicao, nao `excludes: '_'`
5. **Cor do highlight**: Usar tom amarelo/laranja com opacidade (nao cobrir texto)
