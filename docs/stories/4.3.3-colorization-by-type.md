# Story 4.3.3: ColorizaÃ§Ã£o por Tipo de ReferÃªncia

**Epic**: 4.3 - ReferÃªncias Bidirecionais & Links Externos com ColorizaÃ§Ã£o
**Status**: ğŸŸ¡ Ready for Development
**Priority**: ğŸ”´ CRÃTICA
**Story Points**: 3
**Assignee**: @dev
**Arch Review**: @architect (Aria - Approving)

---

## ğŸ“– USER STORY

**Como** um estudioso bÃ­blico
**Quero** ver cores diferentes para tipos de referÃªncia (interna/externa/bidirecional)
**Para** identificar rapidamente o contexto e tipo de cada referÃªncia

### Why This Matters
- ğŸ‘ï¸ **Clareza Visual**: Cores naturalmente indicam tipo/direÃ§Ã£o
- âš¡ **UX RÃ¡pida**: Identifica tipo sem ler texto
- ğŸ¨ **PadrÃ£o Obsidian**: Alinha com design de second-brain apps

---

## âœ… CRITÃ‰RIOS DE ACEITAÃ‡ÃƒO

### A. Cores SemÃ¢nticas Aplicadas

```gherkin
Scenario: ReferÃªncia que EU criei (Aâ†’B)
  Given estou em Salmos 10
  And criei referÃªncia para ProvÃ©rbios 21
  When ReferencesSidebar renderiza
  Then vejo card COM FUNDO VERDE CLARO
  And contraste do texto Ã© WCAG AA
  And Ã­cone opcional (ou apenas cor diferencia)

Scenario: ReferÃªncia criada para MIM (Bâ†A)
  Given estou em ProvÃ©rbios 21
  And Salmos 10 referencia este estudo
  When ReferencesSidebar renderiza
  Then vejo card COM FUNDO VERMELHO CLARO
  And Ã© visualmente diferente do verde

Scenario: Link externo (URL)
  Given tenho link https://example.com
  When ReferencesSidebar renderiza
  Then vejo card COM FUNDO AZUL CLARO
  And diferencia dos outros dois tipos
```

**ValidaÃ§Ãµes TÃ©cnicas**:
- [ ] Verde: `bg-green-50 border-green-200` (ou design token)
- [ ] Vermelho: `bg-red-50 border-red-200` (ou design token)
- [ ] Azul: `bg-blue-50 border-blue-200` (ou design token)
- [ ] Cores sÃ£o claras (nÃ£o saturadas)
- [ ] Contraste: WCAG AA (4.5:1 para texto)

---

### B. Cores em Todos os Estados

```gherkin
Scenario: Cor mantida em hover
  Given vejo card referÃªncia em verde
  When passo mouse
  Then permanece verde (com hover effect)
  And aÃ§Ãµes aparecem (delete, reorder buttons)

Scenario: Cor mantida em drag
  Given estou arrastando referÃªncia verde
  When levanto mouse
  Then card nÃ£o perde cor
  And opacity pode mudar (fade) mas cor mantÃ©m

Scenario: Cor mantida em loading
  Given ReferencesSidebar estÃ¡ carregando
  When skeleton renderiza
  Then skeleton tem cor correta (verde/vermelho/azul)
  And loading animator nÃ£o apaga cores
```

**ValidaÃ§Ãµes TÃ©cnicas**:
- [ ] Hover: CSS `hover:bg-green-100` mantÃ©m cor
- [ ] Drag: opacity 0.5 mas cor preservada
- [ ] Loading skeleton: mesmo cor, sÃ³ sem conteÃºdo

---

### C. Design Tokens Utilizados

```gherkin
Scenario: Usar src/lib/design-tokens.ts
  Given arquivos usam design tokens
  When importo REFERENCE_TYPE_COLORS
  Then cÃ³digo Ã© limpo e centralizador
  And mudanÃ§as de cor sÃ£o 1 lugar sÃ³

Scenario: Fallback se token nÃ£o existir
  Given REFERENCE_TYPE_COLORS nÃ£o existe ainda
  When esta story executa
  Then cria novo export em design-tokens.ts
  And outros arquivos importam dele
```

**ValidaÃ§Ãµes TÃ©cnicas**:
- [ ] Token exportado: `REFERENCE_TYPE_COLORS`
- [ ] Estrutura: `{ references: string, referenced_by: string, external: string }`
- [ ] Valor: Tailwind class string ou hex color

---

### D. Sem Ãcones/Badges (Apenas Cor)

```gherkin
Scenario: DiferenciaÃ§Ã£o Ã© APENAS pela cor
  Given nÃ£o adicionar Ã­conesâ†’, â†, ğŸ”—
  And nÃ£o adicionar badges "Referencia", "Referenciado"
  When card renderiza
  Then cor Ã© Ãºnico diferenciador
  And design minimalista (como especificado)
```

---

## ğŸ› ï¸ TASKS TÃ‰CNICAS

### Design Tokens (`src/lib/design-tokens.ts`)

- [ ] **Adicionar novo export**
  ```typescript
  // src/lib/design-tokens.ts

  export const REFERENCE_TYPE_COLORS = {
    // "Eu referencio" (Aâ†’B, is_bidirectional: true)
    references: 'bg-green-50 border-green-200 hover:bg-green-100',

    // "Fui referenciado" (Bâ†A, is_bidirectional: false)
    referenced_by: 'bg-red-50 border-red-200 hover:bg-red-100',

    // "Link externo"
    external: 'bg-blue-50 border-blue-200 hover:bg-blue-100'
  } as const;

  // Type-safe enum (optional)
  export type ReferenceTypeColor = keyof typeof REFERENCE_TYPE_COLORS;
  ```

- [ ] **Validar contraste WCAG AA**
  - [ ] Green 50 + Green 200 border + preto texto = pass
  - [ ] Red 50 + Red 200 border + preto texto = pass
  - [ ] Blue 50 + Blue 200 border + preto texto = pass
  - [ ] Usar WebAIM contrast checker (online)

---

### Frontend Utility (`src/lib/reference-utils.ts`)

- [ ] **Criar helper para determinar cor**
  ```typescript
  // src/lib/reference-utils.ts

  import { REFERENCE_TYPE_COLORS } from './design-tokens';

  export function getReferenceTypeColor(reference: Reference): string {
    // Internal references
    if (reference.link_type === 'internal') {
      // Eu referencio (bidirecional criada por mim)
      if (reference.is_bidirectional === true) {
        return REFERENCE_TYPE_COLORS.references;
      }
      // Fui referenciado (reversa criada por trigger)
      if (reference.is_bidirectional === false) {
        return REFERENCE_TYPE_COLORS.referenced_by;
      }
    }

    // External links
    if (reference.link_type === 'external') {
      return REFERENCE_TYPE_COLORS.external;
    }

    // Fallback (nunca chega aqui se data correta)
    return REFERENCE_TYPE_COLORS.references;
  }

  export function getReferenceTypeLabel(reference: Reference): string {
    if (reference.link_type === 'external') return 'Link Externo';
    if (reference.is_bidirectional === true) return 'ReferÃªncia';
    return 'Referenciado por';
  }
  ```

---

### Frontend/Component (`SortableReferenceItem.tsx`)

- [ ] **Aplicar cor via className**
  ```typescript
  // src/components/Editor/SortableReferenceItem.tsx

  import { getReferenceTypeColor } from '@/lib/reference-utils';
  import { REFERENCE_TYPE_COLORS } from '@/lib/design-tokens';

  export function SortableReferenceItem({
    reference,
    isDragging,
    onDelete,
    onReorder,
  }: Props) {
    const cardColor = getReferenceTypeColor(reference);

    return (
      <div
        className={cn(
          'px-4 py-3 rounded-lg border transition-all',
          cardColor,  // â† Aplicar cor aqui!
          isDragging && 'opacity-50'  // Drag state preserva cor
        )}
      >
        {/* conteÃºdo */}
      </div>
    );
  }
  ```

---

### Frontend/Component (`ReferenceCard.tsx`)

- [ ] **Card jÃ¡ renderiza, apenas aplicar classe**
  ```typescript
  // Se ReferenceCard Ã© used elsewhere, aplicar cor tambÃ©m
  export function ReferenceCard({ reference }: Props) {
    const cardColor = getReferenceTypeColor(reference);

    return (
      <div className={cn('px-4 py-3 rounded-lg border', cardColor)}>
        {/* existing content */}
      </div>
    );
  }
  ```

---

### Frontend/Skeleton (`ReferencesSidebar.tsx` Loading State)

- [ ] **Skeleton carrega com cor correta**
  ```typescript
  // Se renderizar skeleton durante load, aplicar cor por tipo
  // SimplificaÃ§Ã£o: skeleton genÃ©rico (sem cores diferentes)
  // Ou: skeleton com cor padrÃ£o (azul/gray)
  ```

---

## ğŸ“Š ESTIMATIVA DE PONTOS

| Task | Horas | Pontos |
|------|-------|--------|
| Design tokens (REFERENCE_TYPE_COLORS) | 0.5h | 1 |
| Helper function (getReferenceTypeColor) | 0.5h | 1 |
| Component updates (className aplicaÃ§Ã£o) | 0.5h | 1 |
| Visual testing + contrast validation | 0.5h | - |
| **Total** | **2h** | **3 pontos** |

---

## ğŸ§ª TESTE CHECKLIST

### Testes Visuais (Manual Browser)

- [ ] **Verde = ReferÃªncia (Aâ†’B)**
  - [ ] Criar referÃªncia
  - [ ] Verificar card em verde claro
  - [ ] Hover em verde mais escuro
  - [ ] Drag â†’ verde com opacity 0.5

- [ ] **Vermelho = Referenciado (Bâ†A)**
  - [ ] Navegar para estudo referenciado
  - [ ] Verificar card vermelho
  - [ ] Cor diferente do verde

- [ ] **Azul = Link Externo**
  - [ ] Adicionar link externo
  - [ ] Card em azul claro
  - [ ] Diferente de verde e vermelho

- [ ] **Estados**
  - [ ] Normal: cor claro
  - [ ] Hover: cor + escuro
  - [ ] Drag: cor com opacity
  - [ ] Skeleton: cor padrÃ£o ou ausente

### Testes de Acessibilidade

- [ ] **Contraste WCAG AA**
  - [ ] Green 50: passe com preto
  - [ ] Red 50: passe com preto
  - [ ] Blue 50: passe com preto
  - [ ] Usar axe-core ou WebAIM

- [ ] **NÃ£o apenas cor**
  - [ ] Texto nÃ£o depende APENAS de cor
  - [ ] Layout/estrutura diferencia tipos
  - [ ] Tooltip ou aria-label adiciona contexto

### Testes Automatizados (E2E)

```typescript
// tests/references-colors.spec.ts
test('referÃªncia tem cor verde', async ({ page }) => {
  // 1. Create reference
  // 2. Verify element has bg-green-50 class
});

test('referÃªncia reversa tem cor vermelha', async ({ page }) => {
  // 1. Navigate to referenced study
  // 2. Verify card has bg-red-50 class
});

test('link externo tem cor azul', async ({ page }) => {
  // 1. Add external link
  // 2. Verify card has bg-blue-50 class
});

// Visual regression test
test('cores sÃ£o preservadas em hover', async ({ page }) => {
  // 1. Screenshot card normal (verde)
  // 2. Hover
  // 3. Screenshot card hover (verde +escuro)
  // 4. Verify colors consistent
});
```

---

## ğŸ” QUALITY GATES

### CodeRabbit Integration

**When**: After creating PR

**Focus Areas**:
- [ ] **Design Tokens**: Usa export correto? Sem hardcoded colors?
- [ ] **Accessibility**: WCAG AA validado? NÃ£o apenas cor?
- [ ] **Consistency**: Cores aplicadas em TODOS componentes?
- [ ] **Performance**: Nenhuma recompilation desnecessÃ¡ria?

**Expected Issues**:
- ğŸŸ¢ LOW: CSS class redundÃ¢ncia (BG + hover) â†’ Nice-to-have refactor

---

## ğŸ“‹ ACCEPTANCE CHECKLIST (Para QA/PM)

- [ ] Verde aparece em referÃªncia Aâ†’B
- [ ] Vermelho aparece em referÃªncia Bâ†A
- [ ] Azul aparece em links externos
- [ ] Cores diferentes claramente
- [ ] Contraste WCAG AA passando (axe-core)
- [ ] Hover preserva cor (mais escura)
- [ ] Drag preserva cor (opacity 0.5)
- [ ] Nenhuma cor hardcoded no componente
- [ ] Design tokens centralizados

---

## ğŸš€ HANDOFF PARA @DEV

### Pre-requisites
1. âœ… Story 4.3.1 e 4.3.2 merge completo (schema + hooks)
2. âœ… `Reference` type com `link_type` + `is_bidirectional`
3. âœ… Branch: `feature/4.3.3-colorization`

### ImplementaÃ§Ã£o (Para @dev)
1. **Fase 1**: Design tokens (0.5h)
2. **Fase 2**: Helper function (0.5h)
3. **Fase 3**: Component updates (0.5h)
4. **Fase 4**: Testing + visual validation (0.5h)

### DefiniÃ§Ã£o de Done
- [ ] PR criada com design tokens
- [ ] Componentes atualizadas
- [ ] WCAG AA passando
- [ ] Visual regression tests pronta
- [ ] Pronto para merge

---

## ğŸ”— DEPENDÃŠNCIAS

### Blockers
- ğŸ”´ Story 4.3.1 (tipos: is_bidirectional)
- ğŸ”´ Story 4.3.2 (tipos: link_type)

### Dependents
- Nenhuma (colorizaÃ§Ã£o Ã© visualmente independente)

---

## ğŸ“š REFERÃŠNCIAS

- **Design Tokens**: `/src/lib/design-tokens.ts`
- **WCAG AA Contrast**: https://webaim.org/resources/contrastchecker
- **Color Psychology**: Verde (aÃ§Ã£o), Vermelho (reaÃ§Ã£o), Azul (externo)
- **Tailwind Colors**: https://tailwindcss.com/docs/customizing-colors

---

## ğŸ“ NOTES

- Cores devem ser claras (50, nÃ£o 600)
- Usar Tailwind defaults ou custom tokens
- Validar contraste automaticamente com axe-core
- NÃ£o adicionar Ã­cones/badges (apenas cor diferencia)
- Helper function torna fÃ¡cil mudar cores depois (1 lugar)

---

**Criada por**: River (Scrum Master) ğŸŒŠ
**Para implementaÃ§Ã£o por**: @dev
**Data**: 2026-01-28
**VersÃ£o**: 1.0 (Ready for Development)
