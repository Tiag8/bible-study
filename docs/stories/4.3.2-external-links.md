# Story 4.3.2: Links Externos (URLs de Sites)

**Epic**: 4.3 - Refer√™ncias Bidirecionais & Links Externos com Coloriza√ß√£o
**Status**: ‚úÖ Done
**Priority**: üî¥ CR√çTICA
**Story Points**: 6
**Assignee**: @dev
**Arch Review**: @architect (Aria - Approving)

---

## üìñ USER STORY

**Como** um estudioso b√≠blico
**Quero** salvar refer√™ncias para artigos, coment√°rios e recursos online
**Para** manter contexto externo (sites, PDFs, v√≠deos) vinculado aos meus estudos

### Why This Matters
- üîó **Contexto Externo**: Integra pesquisa externa com estudo local
- üìö **Profundidade**: Permite referenciar coment√°rios de te√≥logos, artigos acad√™micos
- üß† **Knowledge Graph**: Conecta internamente + externamente (like Roam)

---

## ‚úÖ CRIT√âRIOS DE ACEITA√á√ÉO

### A. Adicionar Link Externo

```gherkin
Scenario: Adicionar URL via ReferencesSidebar
  Given estou em um estudo
  When clico "+" em ReferencesSidebar
  Then vejo modal "Adicionar Refer√™ncia"
  And vejo 2 abas: "Estudo Interno" | "Link Externo"
  And clico "Link Externo"
  And digito: https://www.example.com/article
  And (opcional) digito t√≠tulo: "Coment√°rio de Spurgeon"
  And clico "Adicionar"
  Then link aparece no sidebar em azul
  And toast: "Link adicionado com sucesso"

Scenario: Link externo sem t√≠tulo customizado
  Given adiciono link https://www.spurgeon.org
  And N√ÉO digito t√≠tulo
  Then t√≠tulo fallback √© "spurgeon.org"
```

**Valida√ß√µes T√©cnicas**:
- [ ] URL validada (regex ou `new URL()`)
- [ ] T√≠tulo √© opcional (fallback = hostname)
- [ ] URL armazenada em `external_url` (VARCHAR 2048)
- [ ] N√£o h√° `target_study_id` (NULL)
- [ ] `link_type = 'external'`
- [ ] N√£o cria refer√™ncia reversa (`is_bidirectional = false`)

---

### B. Visualizar Link Externo

```gherkin
Scenario: Link externo renderizado como clic√°vel
  Given estou no estudo e vejo link externo no sidebar
  Then vejo card azul claro
  And vejo √≠cone üîó ou URL underlined
  And t√≠tulo √© "Coment√°rio de Spurgeon"
  When clico no card
  Then abre https://www.spurgeon.org em aba nova (target="_blank")
  And p√°gina original n√£o sai do foco

Scenario: URL inv√°lida n√£o √© renderizada
  Given URL n√£o √© https/http v√°lida
  Then componente n√£o renderiza (error state ou hidden)
```

**Valida√ß√µes T√©cnicas**:
- [ ] Card renderiza com `bg-blue-50 border-blue-200` (ou design token)
- [ ] `<a href={external_url} target="_blank" rel="noopener noreferrer">`
- [ ] T√≠tulo vem de `external_url` ou campo `title` (se adicionado)
- [ ] Mobile: link abre em browser padr√£o

---

### C. Deletar Link Externo

```gherkin
Scenario: Deletar URL do sidebar
  Given estou vendo link externo "Spurgeon"
  When clico "X" no card
  Then vejo modal de confirma√ß√£o: "Remover link?"
  And clico "Remover"
  Then link desaparece do sidebar
  And toast: "Link removido: spurgeon.org"
  And DELETE executa sem afetar outros links
```

**Valida√ß√µes T√©cnicas**:
- [ ] Delete √© simples (1 linha, n√£o bidirecional)
- [ ] Usa direto DELETE ou RPC
- [ ] RLS: `WHERE user_id = auth.uid()`

---

### D. Valida√ß√£o de URLs

```gherkin
Scenario: URL inv√°lida √© rejeitada
  Given digito "not-a-url" ou "ftp://invalid"
  Then vejo erro: "URL inv√°lida (https:// ou http://)"
  And bot√£o "Adicionar" est√° desabilitado

Scenario: URL duplicada √© detectada
  Given j√° tenho https://example.com neste estudo
  When tento adicionar novamente
  Then vejo erro: "Este link j√° foi adicionado"
  And modal permanece aberta
```

**Valida√ß√µes T√©cnicas**:
- [ ] Valida√ß√£o frontend: regex ou `new URL()`
- [ ] Valida√ß√£o backend: CHECK constraint ou trigger (opcional para MVP)
- [ ] UNIQUE em (user_id, study_id, external_url)

---

### E. Limita√ß√µes (Escopo MVP)

```gherkin
Scenario: Sem preview de URL
  Given adiciono link
  Then N√ÉO busco Open Graph (n√£o fazer agora)
  And N√ÉO mostro favicon (nice-to-have para v2)
  And N√ÉO fa√ßo "link checker" (v2)

Scenario: URL longa n√£o quebra layout
  Given URL √© https://www.example.com/article/very-long-path/...
  Then trunca com ellipsis ou word-break
  And tooltip mostra URL completa
```

---

## üõ†Ô∏è TASKS T√âCNICAS

### Database (Backend)

- [ ] **Migration**: Colunas adicionadas em 4.3.1 (reutilizar)
  ```sql
  -- J√° adicionado em 4.3.1:
  ALTER TABLE bible_study_links ADD COLUMN (
    link_type VARCHAR(20) DEFAULT 'internal'
      CHECK (link_type IN ('internal', 'external')),
    external_url VARCHAR(2048)
  );

  -- Valida√ß√£o (opcional para MVP)
  ALTER TABLE bible_study_links
  ADD CONSTRAINT unique_external_link
  UNIQUE (user_id, source_study_id, external_url)
  WHERE link_type = 'external';
  ```

---

### Backend/Hook (`useReferences.ts`)

- [ ] **Nova fun√ß√£o: `addExternalLink()`**
  ```typescript
  export interface ExternalLinkInput {
    url: string;
    title?: string;  // Fallback para hostname se n√£o fornecido
  }

  async function addExternalLink(link: ExternalLinkInput): Promise<boolean> {
    // 1. Validar URL
    try {
      new URL(link.url);
    } catch {
      throw new Error('URL inv√°lida');
    }

    // 2. Verificar duplicata
    const { data: existing } = await supabase
      .from('bible_study_links')
      .select('id')
      .eq('user_id', user?.id)
      .eq('source_study_id', studyId)
      .eq('link_type', 'external')
      .eq('external_url', link.url)
      .single();

    if (existing) {
      throw new Error('Este link j√° foi adicionado');
    }

    // 3. Insert
    const { data, error } = await supabase
      .from('bible_study_links')
      .insert({
        user_id: user?.id,
        source_study_id: studyId,
        target_study_id: null,  // ‚Üê N√£o √© estudo
        link_type: 'external',
        external_url: link.url,
        is_bidirectional: false  // ‚Üê N√£o cria reverso
      })
      .select();

    if (error) throw error;

    // 4. Refetch
    await refetch();

    return true;
  }
  ```

- [ ] **Atualizar tipo `Reference`**
  ```typescript
  export interface Reference {
    // ... existing fields
    link_type: 'internal' | 'external';
    external_url?: string | null;
    // target_study_id pode ser null se external
  }
  ```

- [ ] **Valida√ß√£o URL helper**
  ```typescript
  export function isValidUrl(url: string): boolean {
    try {
      const parsed = new URL(url);
      return ['http:', 'https:'].includes(parsed.protocol);
    } catch {
      return false;
    }
  }

  export function getUrlDisplayTitle(url: string, customTitle?: string): string {
    if (customTitle) return customTitle;
    try {
      return new URL(url).hostname;
    } catch {
      return url;
    }
  }
  ```

---

### Frontend/Modal (`AddReferenceModal.tsx`)

- [ ] **Tab switcher: Internal | External**
  ```typescript
  const [activeTab, setActiveTab] = useState<'internal' | 'external'>('internal');

  return (
    <div>
      {/* Tab buttons */}
      <button onClick={() => setActiveTab('internal')}>
        Estudo Interno
      </button>
      <button onClick={() => setActiveTab('external')}>
        Link Externo
      </button>

      {activeTab === 'internal' && <InternalReferenceForm />}
      {activeTab === 'external' && <ExternalLinkForm />}
    </div>
  );
  ```

- [ ] **ExternalLinkForm (novo componente)**
  ```typescript
  function ExternalLinkForm({ onAdd }: { onAdd: (url: string, title?: string) => void }) {
    const [url, setUrl] = useState('');
    const [title, setTitle] = useState('');
    const [error, setError] = useState<string | null>(null);

    const handleAdd = async () => {
      if (!isValidUrl(url)) {
        setError('URL deve ser https:// ou http://');
        return;
      }

      try {
        await onAdd(url, title || undefined);
        setUrl('');
        setTitle('');
      } catch (err) {
        setError(err.message);
      }
    };

    return (
      <div>
        <input
          type="url"
          placeholder="https://example.com"
          value={url}
          onChange={e => {
            setUrl(e.target.value);
            setError(null);  // Clear error on change
          }}
        />

        <input
          type="text"
          placeholder="T√≠tulo (opcional)"
          value={title}
          onChange={e => setTitle(e.target.value)}
        />

        {error && <div className="text-red-600">{error}</div>}

        <button
          onClick={handleAdd}
          disabled={!url || !isValidUrl(url)}
        >
          Adicionar Link
        </button>
      </div>
    );
  }
  ```

---

### Frontend/Component (`ReferenceCard.tsx`)

- [ ] **Renderizar link externo como clic√°vel**
  ```typescript
  export function ReferenceCard({ reference }: { reference: Reference }) {
    if (reference.link_type === 'external') {
      return (
        <a
          href={reference.external_url}
          target="_blank"
          rel="noopener noreferrer"
          className="text-blue-600 hover:underline"
        >
          {getUrlDisplayTitle(reference.external_url)}
        </a>
      );
    }

    // ... render internal reference
  }
  ```

---

### Frontend/Component (`SortableReferenceItem.tsx`)

- [ ] **N√£o renderizar delete para links do mesmo card**
  ```typescript
  // Links externos s√£o delet√°veis (ao contr√°rio de refs bidirecionais)
  // Bot√£o delete aparece para todos
  ```

- [ ] **Renderizar √≠cone diferente para external**
  ```typescript
  {reference.link_type === 'external' && <ExternalLinkIcon />}
  ```

---

## üìä ESTIMATIVA DE PONTOS

| Task | Horas | Pontos |
|------|-------|--------|
| Hook: `addExternalLink()` | 1.5h | 2 |
| Modal: Tab + ExternalLinkForm | 1.5h | 2 |
| Component updates | 1h | 1 |
| Valida√ß√£o + error handling | 1h | 1 |
| Testing (E2E + manual) | 1.5h | - |
| **Total** | **6.5h** | **6 pontos** |

---

## üß™ TESTE CHECKLIST

### Testes Manuais (Browser)

- [ ] **Adicionar link externo**
  - [ ] Clica "+" ‚Üí Tab "Link Externo"
  - [ ] Digita https://www.example.com
  - [ ] Sem t√≠tulo customizado ‚Üí fallback "example.com"
  - [ ] Clica "Adicionar"
  - [ ] Link aparece no sidebar em azul

- [ ] **Clicar em link externo**
  - [ ] Link abre em aba nova
  - [ ] P√°gina original n√£o sai de foco

- [ ] **Deletar link externo**
  - [ ] Clica X ‚Üí confirma√ß√£o
  - [ ] "Remover link?" aparece
  - [ ] Clica "Remover"
  - [ ] Link desaparece
  - [ ] Toast: "Link removido"

- [ ] **Valida√ß√£o**
  - [ ] Digita "not-a-url" ‚Üí erro
  - [ ] Digita URL sem protocol ‚Üí erro
  - [ ] Bot√£o "Adicionar" fica disabled
  - [ ] Mesmo link 2x ‚Üí erro "j√° foi adicionado"

### Testes Automatizados (E2E)

```typescript
// tests/external-links.spec.ts
test('adicionar link externo', async ({ page }) => {
  // 1. Click "+"
  // 2. Switch to "Link Externo" tab
  // 3. Type URL
  // 4. Click "Adicionar"
  // 5. Verify appears in sidebar
});

test('clicar em link abre em nova aba', async ({ browser }) => {
  // 1. Click external link
  // 2. Verify opens in new tab with target="_blank"
});

test('valida√ß√£o de URL', async ({ page }) => {
  // 1. Type invalid URL
  // 2. Verify error message
  // 3. Verify button disabled
});
```

---

## üîç QUALITY GATES

### CodeRabbit Integration

**When**: After creating PR

**Focus Areas**:
- [ ] **Valida√ß√£o**: URL validation logic correcta?
- [ ] **Security**: `target="_blank"` tem `rel="noopener noreferrer"`?
- [ ] **UX**: Error messages claros? Button states corretos?
- [ ] **TypeScript**: Types completos para `external_url`?

**Expected Issues**:
- üü° HIGH: Missing `rel` on external links ‚Üí Security risk
- üü¢ MEDIUM: URL validation duplicada (hook + component) ‚Üí Refactor

---

## üìã ACCEPTANCE CHECKLIST (Para QA/PM)

- [ ] URL v√°lida √© aceita (https + http)
- [ ] URL inv√°lida √© rejeitada com erro claro
- [ ] Link aparece em azul no sidebar
- [ ] Clique abre em aba nova
- [ ] Delete remove link (sem afetar outros)
- [ ] T√≠tulo fallback funciona (hostname)
- [ ] Sem duplicatas de URL
- [ ] Acessibilidade: Links t√™m aria-label
- [ ] Mobile: Link funciona no browser padr√£o

---

## üöÄ HANDOFF PARA @DEV

### Pre-requisites
1. ‚úÖ Story 4.3.1 (bidirectional) merge completo
2. ‚úÖ Schema com `link_type` + `external_url` (4.3.1)
3. ‚úÖ Branch: `feature/4.3.2-external-links`

### Implementa√ß√£o (Para @dev)
1. **Fase 1**: Hook `addExternalLink()` + valida√ß√£o (2h)
2. **Fase 2**: Modal Tab + Form (1.5h)
3. **Fase 3**: Component rendering (1h)
4. **Fase 4**: Testing (1.5h)

### Defini√ß√£o de Done
- [ ] PR criada com testes passando
- [ ] CodeRabbit review aprovado
- [ ] URL valida√ß√£o funcionando
- [ ] E2E test passando
- [ ] Pronto para merge

---

## üîó DEPEND√äNCIAS

### Blockers
- üî¥ Story 4.3.1 (schema + trigger)

### Dependents
- üì¶ Story 4.3.3 (coloriza√ß√£o) - Depende de `link_type` enum

---

## üìö REFER√äNCIAS

- **Epic**: `/docs/stories/EPIC-4.3-enhanced-references.md`
- **Story 4.3.1**: Bidirectional references (schema)
- **URL Validation**: MDN - URL API
- **Best Practice**: noopener noreferrer para external links

---

## üìù NOTES

- N√£o fazer Open Graph preview nesta story (v2)
- T√≠tulo √© opcional (fallback hostname √© OK)
- Deletar √© simples (n√£o bidirecional)
- Refetch ap√≥s add/delete para manter UI sincronizada

---

**Criada por**: River (Scrum Master) üåä
**Para implementa√ß√£o por**: @dev
**Data**: 2026-01-28
**Vers√£o**: 1.0 (Ready for Development)
