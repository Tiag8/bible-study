# Story 4.3.1: ReferÃªncias Bidirecionais AutomÃ¡ticas

**Epic**: 4.3 - ReferÃªncias Bidirecionais & Links Externos com ColorizaÃ§Ã£o
**Status**: âœ… Done
**Priority**: ğŸ”´ CRÃTICA
**Story Points**: 7
**Assignee**: @dev
**Arch Review**: @architect (Aria - Approving)

---

## ğŸ“– USER STORY

**Como** um estudioso bÃ­blico
**Quero** que quando eu referencio um estudo (ex: Salmos 10 â†’ ProvÃ©rbios 21), a referÃªncia reversa seja criada automaticamente
**Para** que eu veja conexÃµes em ambas as direÃ§Ãµes sem aÃ§Ã£o manual duplicada

### Why This Matters
- ğŸ§  **Knowledge Graph**: PadrÃ£o Obsidian/Roam Research (bidirectional linking)
- ğŸ¯ **Usabilidade**: Contexto completo de relacionamentos sem esforÃ§o duplicado
- ğŸ“Š **InteligÃªncia**: Identifica tÃ³picos frequentemente referenciados

---

## âœ… CRITÃ‰RIOS DE ACEITAÃ‡ÃƒO

### A. Criar ReferÃªncia (SÃ­ncrona)

```gherkin
Scenario: Criar referÃªncia Aâ†’B cria automaticamente Bâ†A
  Given estou no estudo "Salmos 10"
  When clico "+" em ReferencesSidebar
  And seleciono "ProvÃ©rbios 21"
  Then vejo referÃªncia "ProvÃ©rbios 21" no sidebar de Salmos 10
  And vejo referÃªncia "Salmos 10" AUTOMATICAMENTE no sidebar de ProvÃ©rbios 21
  And ambas aparecem no mesmo loading (sem delay)
  And nÃ£o hÃ¡ duplicatas (UNIQUE constraint)
```

**ValidaÃ§Ãµes TÃ©cnicas**:
- [ ] ReferÃªncia Aâ†’B: `{source: Salmos 10, target: ProvÃ©rbios 21, is_bidirectional: true}`
- [ ] ReferÃªncia Bâ†A: `{source: ProvÃ©rbios 21, target: Salmos 10, is_bidirectional: false}`
- [ ] Marker `is_bidirectional: false` na reversa (criada por trigger)
- [ ] Ambas tÃªm mesmo `user_id`

---

### B. Visualizar ReferÃªncias (Bidirecional)

```gherkin
Scenario: Sidebar mostra referÃªncias em ambas direÃ§Ãµes com cores diferentes
  Given estou no estudo "Salmos 10"
  When ReferencesSidebar carrega
  Then vejo card verde: "ProvÃ©rbios 21" (com Ã­cone â†’)
  And vejo card vermelho: "Salmos 10" (com Ã­cone â†) SE foi referenciado

Scenario: Clicar em referÃªncia navega para estudo
  Given vejo referÃªncia "ProvÃ©rbios 21" no sidebar
  When clico no card
  Then navego para /estudo/{proverbios-21-id}
  And sidebar atualiza para mostrar referÃªncias de ProvÃ©rbios 21
```

**ValidaÃ§Ãµes TÃ©cnicas**:
- [ ] Card verde = `is_bidirectional: true` (eu referencio)
- [ ] Card vermelho = `is_bidirectional: false` (fui referenciado)
- [ ] Clique em card executa `router.push(/estudo/{id})`
- [ ] Sidebar refetch ao navegar

---

### C. Deletar ReferÃªncia (Atomicamente de Qualquer Lado)

```gherkin
Scenario: Deletar em Salmos 10 remove de ambos
  Given estou em Salmos 10
  And vejo referÃªncia verde "ProvÃ©rbios 21"
  When clico "X" no card e confirmo
  Then referÃªncia desaparece de Salmos 10
  And referÃªncia desaparece SIMULTANEAMENTE de ProvÃ©rbios 21
  And vejo toast: "ReferÃªncia removida: ProvÃ©rbios 21"

Scenario: Deletar em ProvÃ©rbios 21 remove de ambos
  Given estou em ProvÃ©rbios 21
  And vejo referÃªncia vermelha "Salmos 10"
  When clico "X"...
  WAIT â†’ NÃ£o posso deletar (readonly)
  Then botÃ£o X nÃ£o aparece em referÃªncias reversas
  And vejo tooltip: "Esta referÃªncia foi criada automaticamente"
```

**ValidaÃ§Ãµes TÃ©cnicas**:
- [ ] DELETE em `{source: Salmos, target: ProvÃ©rbios}` remove ambas
- [ ] DELETE usa RPC `delete_bidirectional_link(link_id)`
- [ ] RPC deleta entry + sua reversa atomicamente
- [ ] Refs com `is_bidirectional: false` nÃ£o tÃªm botÃ£o delete
- [ ] RLS garante `user_id` match em ambas as queries

---

### D. RLS e SeguranÃ§a

```gherkin
Scenario: User A nÃ£o vÃª referÃªncias de User B
  Given User A criou Salmos 10
  And User B criou Salmos 10 (seu prÃ³prio)
  When User A abre /estudo/{A-salmos-id}
  Then vÃª APENAS as referÃªncias de User A
  And nÃ£o vÃª referÃªncias de User B (mesmo se existem)
```

**ValidaÃ§Ãµes TÃ©cnicas**:
- [ ] Query SELECT filtra `WHERE user_id = auth.uid()`
- [ ] Trigger valida `NEW.user_id = (SELECT user_id FROM bible_studies WHERE id = NEW.source_study_id)`
- [ ] RPC `delete_bidirectional_link` valida `user_id` match

---

## ğŸ› ï¸ TASKS TÃ‰CNICAS

### Database (Backend)

- [ ] **Migration**: `supabase/migrations/20260128_004_add_bidirectional_references.sql`
  ```sql
  ALTER TABLE bible_study_links ADD COLUMN is_bidirectional BOOLEAN DEFAULT true;
  -- Ãndice existente jÃ¡ cobre nova coluna
  ```

- [ ] **Trigger**: `sync_bidirectional_link()`
  - [ ] INSERT novo â†’ verifica se `link_type = 'internal'`
  - [ ] Se sim â†’ INSERT reverso com `is_bidirectional = false`
  - [ ] `ON CONFLICT DO NOTHING` (idempotente)
  - [ ] `pg_trigger_depth()` para prevenir loops (se necessÃ¡rio)

- [ ] **RPC Function**: `delete_bidirectional_link(link_id UUID)`
  ```sql
  CREATE OR REPLACE FUNCTION delete_bidirectional_link(link_id UUID)
  RETURNS void AS $$
  DECLARE
    source_id UUID;
    target_id UUID;
    user_id_check UUID;
  BEGIN
    -- Fetch original link + validate user_id
    SELECT source_study_id, target_study_id, user_id
    INTO source_id, target_id, user_id_check
    FROM bible_study_links
    WHERE id = link_id;

    -- RLS check
    IF user_id_check != auth.uid() THEN
      RAISE EXCEPTION 'Unauthorized';
    END IF;

    -- Delete original
    DELETE FROM bible_study_links WHERE id = link_id;

    -- Delete reverso
    DELETE FROM bible_study_links
    WHERE source_study_id = target_id
    AND target_study_id = source_id
    AND user_id = user_id_check
    AND link_type = 'internal'
    AND is_bidirectional = false;
  END;
  $$ LANGUAGE plpgsql;
  ```

- [ ] **Tests**: SQL validation script
  - [ ] Insert Aâ†’B, verify Bâ†A created
  - [ ] Delete via RPC, verify both gone
  - [ ] RLS validation on delete

---

### Backend/Hook (`useReferences.ts`)

- [ ] **Update `addReference()`**
  ```typescript
  // JÃ¡ existe, adicionar:
  async function addReference(targetStudyId: string): Promise<boolean> {
    // ... validaÃ§Ãµes existentes
    // Trigger agora cria a reversa automaticamente
    // Refetch apÃ³s INSERT para pegar ambas
  }
  ```

- [ ] **Add `deleteReference()` com RPC**
  ```typescript
  async function deleteReference(referenceId: string): Promise<boolean> {
    // Use RPC helper ao invÃ©s de direto DELETE
    const { error } = await supabase.rpc('delete_bidirectional_link', {
      link_id: referenceId
    });

    if (error) throw error;

    // Refetch para atualizar UI
    await refetch();

    return true;
  }
  ```

- [ ] **Update tipo `Reference`**
  ```typescript
  export interface Reference {
    // ... existing fields
    is_bidirectional: boolean;  // â† novo
  }
  ```

- [ ] **Refetch logic**
  - [ ] `refetch()` deve buscar AMBAS Aâ†’B e Bâ†A
  - [ ] Join com `target_study_id` para enriquecer dados

---

### Frontend/Component (`ReferencesSidebar.tsx`)

- [ ] **Atualizar `deleteReference` callback**
  ```typescript
  // Usar novo handler que chama RPC
  const handleDeleteReference = async (refId: string) => {
    setDeleting(refId);
    try {
      const success = await deleteReference(refId);
      if (success) {
        toast.success('ReferÃªncia removida');
      }
    } finally {
      setDeleting(refId);
    }
  }
  ```

---

### Frontend/Component (`SortableReferenceItem.tsx`)

- [ ] **Renderizar cor baseada em `is_bidirectional`**
  ```typescript
  // Importar novo helper (criado em colorizaÃ§Ã£o story)
  const cardColor = getReferenceTypeColor(reference);

  return (
    <div className={cn(
      'px-4 py-3 rounded-lg border',
      cardColor  // â† verde ou vermelho
    )}>
  ```

- [ ] **Ocultar delete button em refs reversas**
  ```typescript
  {!reference.is_bidirectional && !deleting && (
    <button onClick={() => handleDelete(reference.id)}>
      {/* delete icon */}
    </button>
  )}
  ```

- [ ] **Tooltip em refs reversas**
  ```typescript
  {!reference.is_bidirectional && (
    <Tooltip content="Esta referÃªncia foi criada automaticamente">
      <InfoIcon />
    </Tooltip>
  )}
  ```

---

## ğŸ“Š ESTIMATIVA DE PONTOS

| Task | Horas | Pontos |
|------|-------|--------|
| Migration + Trigger | 1.5h | 2 |
| RPC Function | 1h | 2 |
| Hook updates | 1.5h | 2 |
| Component updates | 1h | 1 |
| Testing (SQL + E2E) | 2h | - |
| **Total** | **7h** | **7 pontos** |

---

## ğŸ§ª TESTE CHECKLIST

### Testes Manuais (Browser)

- [ ] **Create bidirecional**
  - [ ] Abrir Salmos 10
  - [ ] Clica "+" â†’ seleciona ProvÃ©rbios 21
  - [ ] VÃª ProvÃ©rbios 21 em verde no sidebar de Salmos 10
  - [ ] Abre ProvÃ©rbios 21 em nova aba
  - [ ] VÃª Salmos 10 em vermelho no sidebar de ProvÃ©rbios 21

- [ ] **Delete de ambos os lados**
  - [ ] De Salmos 10: delete ProvÃ©rbios 21
  - [ ] VÃª desaparecer de ambos os sidebars simultaneamente
  - [ ] Toast: "ReferÃªncia removida: ProvÃ©rbios 21"
  - [ ] Recarrega pÃ¡gina â†’ ProvÃ©rbios 21 nÃ£o aparece

- [ ] **Refs reversas readonly**
  - [ ] Em ProvÃ©rbios 21, clica X no card de Salmos 10
  - [ ] Nada acontece (botÃ£o deve estar oculto)
  - [ ] Pairar sobre card â†’ vÃª tooltip

### Testes Automatizados (E2E)

```typescript
// tests/references-bidirectional.spec.ts
test('criar referÃªncia Aâ†’B cria Bâ†A', async ({ page }) => {
  // 1. Navigate to Salmos 10
  // 2. Click "+" and select ProvÃ©rbios 21
  // 3. Verify it appears in Salmos 10 sidebar (green)
  // 4. Open ProvÃ©rbios 21
  // 5. Verify Salmos 10 appears (red)
});

test('deletar de um lado remove do outro', async ({ page }) => {
  // 1. Delete from Salmos 10
  // 2. Verify both sidebars updated
  // 3. Reload page
  // 4. Verify both gone
});
```

### SQL Tests

```sql
-- Verify bidirectional creation
SELECT COUNT(*) FROM bible_study_links
WHERE source_study_id = 'A' AND target_study_id = 'B'
AND is_bidirectional = true;
-- Expected: 1

SELECT COUNT(*) FROM bible_study_links
WHERE source_study_id = 'B' AND target_study_id = 'A'
AND is_bidirectional = false;
-- Expected: 1 (created by trigger)
```

---

## ğŸ” QUALITY GATES

### CodeRabbit Integration

**When**: After creating PR (via @github-devops)

**Focus Areas**:
- [ ] **PadrÃµes arquiteturais**: Trigger idempotente? RPC bem-formado?
- [ ] **Security**: RLS validation em todas as queries?
- [ ] **Performance**: Ãndices suficientes? N+1 queries?
- [ ] **TypeScript**: Types completos? Nenhum `any`?

**Expected Issues**:
- ğŸŸ¡ HIGH: Missing RLS check em RPC â†’ FIX antes de merge
- ğŸŸ¢ MEDIUM: Missing error handling em hook â†’ Document como tech debt

---

## ğŸ“‹ ACCEPTANCE CHECKLIST (Para QA/PM)

- [ ] ReferÃªncia Aâ†’B cria Bâ†A (ambas aparecem)
- [ ] Delete de qualquer lado remove ambas
- [ ] Refs reversas nÃ£o tÃªm botÃ£o delete
- [ ] Cores corretas (verde/vermelho conforme story 4.3.3)
- [ ] RLS funciona (user A nÃ£o vÃª refs de user B)
- [ ] Performance: load < 200ms
- [ ] Sem erros no console
- [ ] Acessibilidade: axe-core clean

---

## ğŸš€ HANDOFF PARA @DEV

### Pre-requisites
1. âœ… Migration criada em `supabase/migrations/`
2. âœ… Tipos TypeScript atualizados
3. âœ… Branches: `feature/4.3.1-bidirectional-references`

### ImplementaÃ§Ã£o (Para @dev)
1. **Fase 1**: Migration + Trigger (1.5h)
2. **Fase 2**: RPC Function (1h)
3. **Fase 3**: Hook + Component updates (2.5h)
4. **Fase 4**: Testing (2h)

### DefiniÃ§Ã£o de Done
- [ ] PR criada com testes passando
- [ ] CodeRabbit review aprovado
- [ ] Nenhum console error
- [ ] E2E test de bidirecional passing
- [ ] Pronto para merge

---

## ğŸ”— DEPENDÃŠNCIAS

### Blockers
- âœ… Story 4.3.3 (colorizaÃ§Ã£o) - Pode ser em paralelo

### Dependents
- ğŸ“¦ Story 4.3.2 (links externos) - Depende de schema base
- ğŸ“¦ Story 4.3.4 (persistÃªncia ordem) - Depende de schema base

---

## ğŸ“š REFERÃŠNCIAS

- **Epic**: `/docs/stories/EPIC-4.3-enhanced-references.md`
- **Arquitetura**: DecisÃµes finalizadas por @architect (Aria)
- **Schema**: `ALTER TABLE bible_study_links ADD COLUMN is_bidirectional`
- **Trigger PadrÃ£o**: `~/.claude/memory/supabase-migrations.md` #16 (3-Phase)
- **RPC PadrÃ£o**: Supabase docs - PostgreSQL Functions

---

## ğŸ“ NOTES

- Trigger deve ser idempotente (ON CONFLICT DO NOTHING)
- RPC precisa de RLS check explÃ­cita
- Refetch Ã© crÃ­tica para manter UI sincronizada
- Delete Ã© atomicamente ambas ou nenhuma (transaÃ§Ã£o)

---

**Criada por**: River (Scrum Master) ğŸŒŠ
**Para implementaÃ§Ã£o por**: @dev
**Data**: 2026-01-28
**VersÃ£o**: 1.0 (Ready for Development)
