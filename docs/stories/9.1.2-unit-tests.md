# Story 9.1.2: Testes Unit√°rios para L√≥gica de Contagem

**Epic**: [EPIC-9.1-chapter-count-fix.md](./EPIC-9.1-chapter-count-fix.md)
**Status**: ‚úÖ Done
**Priority**: üü† SHOULD HAVE
**Assignee**: @qa, @dev
**Estimativa**: 40 min
**Depende de**: 9.1.1 (fix deve estar aplicado)

---

## User Story

**Como** um desenvolvedor,
**Quero** testes automatizados para a l√≥gica de contagem de cap√≠tulos,
**Para** prevenir regress√µes futuras e garantir corretude.

---

## Contexto

### Situa√ß√£o Atual
- Cobertura de testes para l√≥gica de contagem: **0%**
- Bug passou despercebido por falta de testes
- Risco alto de regress√£o em futuras mudan√ßas

### Objetivo
- Cobertura de testes: **100%** para l√≥gica de contagem
- Edge cases documentados e testados
- CI/CD previne regress√µes automaticamente

---

## Acceptance Criteria

### Testes Obrigat√≥rios
- [ ] Test case: 0 estudos = 0 cap√≠tulos estudados
- [ ] Test case: 1 estudo em 1 cap√≠tulo = 1 cap√≠tulo
- [ ] Test case: 2 estudos no MESMO cap√≠tulo = 1 cap√≠tulo √∫nico
- [ ] Test case: 2 estudos em cap√≠tulos DIFERENTES = 2 cap√≠tulos
- [ ] Test case: M√∫ltiplos estudos distribu√≠dos (3 no cap 1, 2 no cap 2) = 2 cap√≠tulos
- [ ] Test case: Livro com 1 cap√≠tulo (Obadias) = 100% quando estudado
- [ ] Test case: Todos os cap√≠tulos estudados = 100%

### T√©cnico
- [ ] Arquivo `tests/unit/chapter-counting.test.ts` criado
- [ ] Todos os testes passam (`npm run test`)
- [ ] Coverage da l√≥gica de contagem = 100%

---

## Especifica√ß√£o T√©cnica

### Arquivo: `tests/unit/chapter-counting.test.ts`

```typescript
import { describe, it, expect } from 'vitest';

/**
 * Fun√ß√£o helper que replica a l√≥gica de contagem de cap√≠tulos √∫nicos
 * usada em DashboardClient.tsx e ChapterView.tsx
 */
function getUniqueChapters(studies: Array<{ chapter_number: number }>): number[] {
  return [...new Set(studies.map(s => s.chapter_number))];
}

describe('Chapter Counting Logic', () => {
  describe('Contagem de Cap√≠tulos √önicos', () => {
    it('retorna array vazio quando n√£o h√° estudos', () => {
      const studies: Array<{ chapter_number: number }> = [];
      const uniqueChapters = getUniqueChapters(studies);

      expect(uniqueChapters).toEqual([]);
      expect(uniqueChapters.length).toBe(0);
    });

    it('conta 1 estudo em 1 cap√≠tulo como 1 cap√≠tulo', () => {
      const studies = [{ chapter_number: 1 }];
      const uniqueChapters = getUniqueChapters(studies);

      expect(uniqueChapters.length).toBe(1);
      expect(uniqueChapters).toEqual([1]);
    });

    it('conta m√∫ltiplos estudos no MESMO cap√≠tulo como 1 cap√≠tulo √∫nico', () => {
      const studies = [
        { chapter_number: 2 },
        { chapter_number: 2 }
      ];
      const uniqueChapters = getUniqueChapters(studies);

      expect(uniqueChapters.length).toBe(1);
      expect(uniqueChapters).toEqual([2]);
    });

    it('conta estudos em cap√≠tulos DIFERENTES corretamente', () => {
      const studies = [
        { chapter_number: 1 },
        { chapter_number: 3 },
        { chapter_number: 5 }
      ];
      const uniqueChapters = getUniqueChapters(studies);

      expect(uniqueChapters.length).toBe(3);
      expect(uniqueChapters).toContain(1);
      expect(uniqueChapters).toContain(3);
      expect(uniqueChapters).toContain(5);
    });

    it('conta 3 estudos no cap 1 + 2 no cap 2 como 2 cap√≠tulos √∫nicos', () => {
      const studies = [
        { chapter_number: 1 },
        { chapter_number: 1 },
        { chapter_number: 1 },
        { chapter_number: 2 },
        { chapter_number: 2 }
      ];
      const uniqueChapters = getUniqueChapters(studies);

      expect(uniqueChapters.length).toBe(2);
    });
  });

  describe('C√°lculo de Progresso', () => {
    it('calcula 0% para livro sem estudos', () => {
      const totalChapters = 50;
      const studiedChapters: number[] = [];
      const progress = (studiedChapters.length / totalChapters) * 100;

      expect(progress).toBe(0);
    });

    it('calcula progresso correto para livro parcialmente estudado', () => {
      const totalChapters = 50; // G√™nesis
      const studiedChapters = [1, 3]; // 2 cap√≠tulos √∫nicos
      const progress = (studiedChapters.length / totalChapters) * 100;

      expect(progress).toBe(4); // 2/50 = 4%
    });

    it('calcula 100% para livro com todos cap√≠tulos estudados', () => {
      const totalChapters = 4; // Rute
      const studiedChapters = [1, 2, 3, 4];
      const progress = (studiedChapters.length / totalChapters) * 100;

      expect(progress).toBe(100);
    });

    it('calcula progresso para livro de 1 cap√≠tulo (Obadias)', () => {
      const totalChapters = 1; // Obadias
      const studiedChapters = [1];
      const progress = (studiedChapters.length / totalChapters) * 100;

      expect(progress).toBe(100);
    });
  });

  describe('BUG REGRESSION: G√™nesis com 2 estudos no cap 2', () => {
    it('deve contar como 1 cap√≠tulo √∫nico, n√£o 2 estudos', () => {
      // Cen√°rio do bug reportado
      const genesisStudies = [
        { book_name: 'G√™nesis', chapter_number: 2, title: 'Estudo 1' },
        { book_name: 'G√™nesis', chapter_number: 2, title: 'Estudo 2' }
      ];

      const studiedChapters = getUniqueChapters(genesisStudies);

      // CR√çTICO: Deve ser 1, n√£o 2
      expect(studiedChapters.length).toBe(1);
      expect(studiedChapters).toEqual([2]);

      // Progresso deve ser 2% (1/50), n√£o 4% (2/50)
      const progress = (studiedChapters.length / 50) * 100;
      expect(progress).toBe(2);
    });
  });

  describe('Total de Cap√≠tulos no Dashboard', () => {
    it('soma cap√≠tulos √∫nicos de m√∫ltiplos livros', () => {
      const books = [
        { name: 'G√™nesis', studiedChapters: [1, 3] },      // 2 cap√≠tulos
        { name: '√äxodo', studiedChapters: [] },            // 0 cap√≠tulos
        { name: 'Rute', studiedChapters: [1, 2, 3, 4] }   // 4 cap√≠tulos
      ];

      const total = books.reduce((acc, b) => acc + b.studiedChapters.length, 0);

      expect(total).toBe(6); // 2 + 0 + 4
    });
  });
});
```

---

## Definition of Done

- [ ] Arquivo de testes criado
- [ ] Todos os 10+ test cases passando
- [ ] Coverage da l√≥gica de contagem = 100%
- [ ] Testes rodam no CI (`npm run test`)
- [ ] Nenhum teste flaky

---

## Comandos

```bash
# Rodar testes
npm run test

# Rodar com coverage
npm run test:coverage

# Rodar apenas este arquivo
npm run test -- tests/unit/chapter-counting.test.ts
```

---

## Commit Message Sugerida

```
test(dashboard): adicionar testes para l√≥gica de contagem de cap√≠tulos

- Criar suite de testes em tests/unit/chapter-counting.test.ts
- Cobrir edge cases: 0 estudos, duplicatas, livros pequenos
- Adicionar teste de regress√£o para bug G√™nesis
- Coverage 100% para l√≥gica de contagem
```

---

**Criado por**: Morgan (PM) üìã + Quinn (QA) üß™
**Data**: 2026-02-05
