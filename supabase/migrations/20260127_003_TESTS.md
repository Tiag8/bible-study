# Story 2.4: Tests para Trigger de Validação de Links

## Cenários de Teste

### ✅ Caso 1: Link Válido (Mesmo user_id)
```sql
-- Setup: Criar 2 estudos do mesmo usuário
INSERT INTO bible_studies (id, user_id, title, book_name, chapter_number)
VALUES 
  ('study-1-uuid', 'user-123', 'Estudo 1', 'Gênesis', 1),
  ('study-2-uuid', 'user-123', 'Estudo 2', 'Gênesis', 2);

-- Test: Criar link entre estudos do mesmo usuário
INSERT INTO bible_study_links (source_study_id, target_study_id)
VALUES ('study-1-uuid', 'study-2-uuid');

-- Resultado esperado: ✓ INSERT sucede
```

### ❌ Caso 2: Link Inválido (user_id diferentes)
```sql
-- Setup: Criar estudos de usuários diferentes
INSERT INTO bible_studies (id, user_id, title, book_name, chapter_number)
VALUES 
  ('study-1-uuid', 'user-123', 'Estudo 1', 'Gênesis', 1),
  ('study-3-uuid', 'user-456', 'Estudo 3', 'Êxodo', 1);

-- Test: Tentar criar link entre estudos de usuários diferentes
INSERT INTO bible_study_links (source_study_id, target_study_id)
VALUES ('study-1-uuid', 'study-3-uuid');

-- Resultado esperado: ✗ ERRO
-- Mensagem: 'Não é permitido criar link entre estudos de usuários diferentes'
```

### ❌ Caso 3: Link com Estudo Inexistente
```sql
-- Test: Tentar criar link com estudo que não existe
INSERT INTO bible_study_links (source_study_id, target_study_id)
VALUES ('study-1-uuid', 'study-inexistente-uuid');

-- Resultado esperado: ✗ ERRO
-- Mensagem: 'Estudo de destino (...) não existe'
```

### ❌ Caso 4: Auto-Link (Estudo linkado consigo mesmo)
```sql
-- Test: Tentar criar link de um estudo consigo mesmo
INSERT INTO bible_study_links (source_study_id, target_study_id)
VALUES ('study-1-uuid', 'study-1-uuid');

-- Resultado esperado: ✗ ERRO
-- Mensagem: 'Um estudo não pode ser linkado consigo mesmo'
```

### ✅ Caso 5: UPDATE de Link Válido
```sql
-- Setup: Criar 3 estudos do mesmo usuário
INSERT INTO bible_studies (id, user_id, title, book_name, chapter_number)
VALUES 
  ('study-1-uuid', 'user-123', 'Estudo 1', 'Gênesis', 1),
  ('study-2-uuid', 'user-123', 'Estudo 2', 'Gênesis', 2),
  ('study-4-uuid', 'user-123', 'Estudo 4', 'Gênesis', 4);

-- Criar link inicial
INSERT INTO bible_study_links (id, source_study_id, target_study_id)
VALUES ('link-1-uuid', 'study-1-uuid', 'study-2-uuid');

-- Test: Atualizar target para estudo válido (mesmo user_id)
UPDATE bible_study_links
SET target_study_id = 'study-4-uuid'
WHERE id = 'link-1-uuid';

-- Resultado esperado: ✓ UPDATE sucede
```

### ❌ Caso 6: UPDATE de Link Inválido
```sql
-- Setup: Criar estudos de usuários diferentes
INSERT INTO bible_studies (id, user_id, title, book_name, chapter_number)
VALUES 
  ('study-1-uuid', 'user-123', 'Estudo 1', 'Gênesis', 1),
  ('study-5-uuid', 'user-456', 'Estudo 5', 'Êxodo', 1);

-- Criar link válido
INSERT INTO bible_study_links (id, source_study_id, target_study_id)
VALUES ('link-1-uuid', 'study-1-uuid', 'study-2-uuid');

-- Test: Atualizar target para estudo de usuário diferente
UPDATE bible_study_links
SET target_study_id = 'study-5-uuid'
WHERE id = 'link-1-uuid';

-- Resultado esperado: ✗ ERRO
-- Mensagem: 'Não é permitido criar link entre estudos de usuários diferentes'
```

---

## Como Executar Testes

### Via Supabase Dashboard
1. Ir para SQL Editor
2. Copiar caso de teste
3. Executar (Run)
4. Verificar resultado

### Via psql (Local)
```bash
# Conectar ao database
psql -h localhost -U postgres -d bible_study

# Executar caso de teste
\i caso1.sql

# Verificar resultado
SELECT * FROM bible_study_links;
```

---

## Checklist de Validação

- [ ] Caso 1 (Link válido): ✓ PASS
- [ ] Caso 2 (user_id diferentes): ✗ FAIL
- [ ] Caso 3 (Estudo inexistente): ✗ FAIL
- [ ] Caso 4 (Auto-link): ✗ FAIL
- [ ] Caso 5 (UPDATE válido): ✓ PASS
- [ ] Caso 6 (UPDATE inválido): ✗ FAIL

**Status**: Ready para teste
